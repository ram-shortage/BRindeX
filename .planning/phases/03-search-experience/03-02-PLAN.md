---
phase: 03-search-experience
plan: 02
type: execute
wave: 2
depends_on: ["03-01", "03-03"]
files_modified:
  - Cargo.toml
  - src/lib.rs
  - src/bin/ffi-search.rs
  - src/ui/mod.rs
  - src/ui/app.rs
  - src/ui/hotkey.rs
  - src/ui/results.rs
  - src/ui/actions.rs
autonomous: false

must_haves:
  truths:
    - "Global hotkey (Ctrl+Space) opens search popup"
    - "Typing shows search results from service"
    - "Up/Down navigates results, Enter opens file"
    - "Esc closes popup"
    - "Results show filename, path, size, modified date"
    - "Ctrl+Shift+C copies path to clipboard"
    - "Ctrl+Shift+E opens containing folder"
  artifacts:
    - path: "src/bin/ffi-search.rs"
      provides: "Search UI binary entry point"
      min_lines: 30
    - path: "src/ui/app.rs"
      provides: "eframe App implementation"
      exports: ["SearchApp"]
    - path: "src/ui/hotkey.rs"
      provides: "Global hotkey handler"
      exports: ["HotkeyManager"]
    - path: "src/ui/results.rs"
      provides: "Results list rendering"
      exports: ["ResultsView"]
    - path: "src/ui/actions.rs"
      provides: "File actions (open, reveal, copy)"
      exports: ["open_file", "reveal_in_explorer", "copy_to_clipboard"]
  key_links:
    - from: "src/ui/app.rs"
      to: "src/ipc/client.rs"
      via: "IpcClient for search queries"
      pattern: "IpcClient::.*search"
    - from: "src/ui/app.rs"
      to: "src/search/parser.rs"
      via: "parse_query for input processing"
      pattern: "search::parse_query"
    - from: "src/bin/ffi-search.rs"
      to: "src/ui/app.rs"
      via: "eframe::run_native"
      pattern: "eframe::run_native"
---

<objective>
Create the search UI with global hotkey, keyboard navigation, and file actions.

Purpose: This is the user-facing interface - a fast popup that appears on hotkey, shows instant search results, and lets users open files with keyboard. This is the core UX of the entire application.

Output: ffi-search binary with egui-based popup, hotkey registration, and file actions.
</objective>

<execution_context>
@/Users/brett/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brett/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-search-experience/03-RESEARCH.md
@.planning/phases/03-search-experience/03-01-SUMMARY.md
@.planning/phases/03-search-experience/03-03-SUMMARY.md

# Existing code context
@src/lib.rs
@src/ipc/mod.rs
@src/ipc/protocol.rs
@src/ipc/client.rs
@src/search/mod.rs
@src/search/parser.rs
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add UI dependencies and create binary entry point</name>
  <files>Cargo.toml, src/bin/ffi-search.rs, src/ui/mod.rs</files>
  <action>
1. Add UI dependencies to Cargo.toml:
   ```toml
   egui = "0.30"
   eframe = { version = "0.30", default-features = false, features = ["default_fonts", "glow", "persistence"] }
   opener = "0.8"
   arboard = "3.4"

   [target.'cfg(windows)'.dependencies]
   win-hotkeys = "0.5"
   ```

2. Add new binary to Cargo.toml:
   ```toml
   [[bin]]
   name = "ffi-search"
   path = "src/bin/ffi-search.rs"
   ```

3. Create src/ui/mod.rs:
   ```rust
   pub mod app;
   pub mod hotkey;
   pub mod results;
   pub mod actions;

   pub use app::SearchApp;
   pub use hotkey::HotkeyManager;
   ```

4. Create src/bin/ffi-search.rs:
   - Initialize tracing for logging
   - Create tokio runtime for async IPC
   - Setup eframe NativeOptions with:
     - Borderless window (decorations: false)
     - Always on top
     - Transparent background (optional)
     - Initial size 600x400
     - Start minimized/hidden
   - Run eframe::run_native with SearchApp
   - Platform gate with #[cfg(windows)]

5. Update src/lib.rs to export ui module:
   ```rust
   pub mod ui;
   ```
  </action>
  <verify>cargo check --bin ffi-search</verify>
  <done>ffi-search binary compiles, eframe window configuration ready</done>
</task>

<task type="auto">
  <name>Task 2: Implement SearchApp with keyboard navigation and search</name>
  <files>src/ui/app.rs, src/ui/results.rs</files>
  <action>
1. Create src/ui/app.rs with SearchApp struct:
   ```rust
   pub struct SearchApp {
       query: String,
       results: Vec<FileResult>,
       selected_index: usize,
       search_pending: bool,
       last_search_time: Option<std::time::Instant>,
       ipc_client: IpcClient,
       runtime: tokio::runtime::Handle,
       should_hide: bool,
   }
   ```

2. Implement eframe::App for SearchApp:
   - `update()`: Main UI render loop
     - Top: Search input field (TextEdit) with focus on show
     - Middle: Results list using ScrollArea::show_rows for virtual scrolling
     - Bottom: Status bar (result count, search time)

   - Keyboard handling in update():
     - Check for key presses via ctx.input()
     - ArrowDown: selected_index += 1 (clamp to results.len()-1)
     - ArrowUp: selected_index -= 1 (saturating_sub)
     - Enter: Open selected file (actions::open_file)
     - Escape: Set should_hide = true
     - Ctrl+Shift+C: Copy selected path to clipboard
     - Ctrl+Shift+E: Reveal selected file in Explorer

3. Search-as-you-type with debounce:
   - On text change, set search_pending = true, record time
   - In update(), if search_pending and 100ms elapsed:
     - Spawn async search via runtime.spawn()
     - Update results when complete (use Arc<Mutex<>> or channel)
   - Show loading indicator while search in progress

4. Create src/ui/results.rs with ResultsView:
   - `pub fn show(ui: &mut egui::Ui, results: &[FileResult], selected: usize) -> Option<usize>`
   - Use ScrollArea::show_rows for efficient rendering with 1M+ results
   - Each row shows: filename | path | size (human readable) | modified date
   - Highlight selected row with different background color
   - Return clicked row index if any
   - Scroll selected row into view

5. Helper functions in results.rs:
   - `format_size(bytes: i64) -> String` - "1.2 MB", "340 KB", etc.
   - `format_date(timestamp: i64) -> String` - "2024-01-15 14:30"
  </action>
  <verify>cargo check --bin ffi-search</verify>
  <done>SearchApp renders UI, keyboard navigation works, search calls IPC client</done>
</task>

<task type="auto">
  <name>Task 3: Implement hotkey manager and file actions</name>
  <files>src/ui/hotkey.rs, src/ui/actions.rs</files>
  <action>
1. Create src/ui/hotkey.rs with HotkeyManager (Windows only):
   ```rust
   #[cfg(windows)]
   pub struct HotkeyManager {
       hkm: win_hotkeys::HotkeyManager,
   }

   #[cfg(windows)]
   impl HotkeyManager {
       pub fn new<F: Fn() + Send + 'static>(on_hotkey: F) -> Result<Self>
       pub fn start(&mut self) -> Result<()>  // Starts event loop in thread
   }
   ```

   Implementation:
   - Register Ctrl+Space as default hotkey (VKey::Space + ModKey::Ctrl)
   - Callback sends message to show/toggle window
   - Run event_loop in separate thread
   - Handle registration failures gracefully (log warning, suggest alternative)

2. Create src/ui/actions.rs with file operations:
   ```rust
   use std::path::Path;
   use crate::Result;

   /// Open file with default application (ACTN-01)
   pub fn open_file(path: &Path) -> Result<()> {
       opener::open(path).map_err(|e| FFIError::Io(e.into()))?;
       Ok(())
   }

   /// Open containing folder with file selected (ACTN-02)
   pub fn reveal_in_explorer(path: &Path) -> Result<()> {
       opener::reveal(path).map_err(|e| FFIError::Io(e.into()))?;
       Ok(())
   }

   /// Copy full path to clipboard (ACTN-03)
   pub fn copy_to_clipboard(path: &Path) -> Result<()> {
       let mut clipboard = arboard::Clipboard::new()
           .map_err(|e| FFIError::Io(std::io::Error::other(e)))?;
       clipboard.set_text(path.to_string_lossy().to_string())
           .map_err(|e| FFIError::Io(std::io::Error::other(e)))?;
       Ok(())
   }
   ```

3. Integrate hotkey with SearchApp:
   - In ffi-search.rs main(), create HotkeyManager
   - Use channel to communicate hotkey events to UI
   - In SearchApp::update(), check for hotkey events
   - Toggle window visibility (or bring to front if already visible)

4. Platform stubs for non-Windows:
   - HotkeyManager returns error on non-Windows
   - Actions use opener which is cross-platform
  </action>
  <verify>cargo check --bin ffi-search</verify>
  <done>Hotkey registration works, file actions (open, reveal, copy) implemented</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete search UI with global hotkey, keyboard navigation, and file actions</what-built>
  <how-to-verify>
  **On Windows:**
  1. Start the FFI service: `cargo run --bin ffi-service` (ensure database has indexed files)
  2. Start the search UI: `cargo run --bin ffi-search`
  3. Press Ctrl+Space - verify popup appears
  4. Type a search query (e.g., "document") - verify results appear within 50ms
  5. Use Up/Down arrows to navigate - verify selection moves
  6. Press Enter on a file - verify it opens in default app
  7. Select a file, press Ctrl+Shift+E - verify Explorer opens with file selected
  8. Select a file, press Ctrl+Shift+C - verify path is in clipboard (paste somewhere)
  9. Press Escape - verify popup closes/hides
  10. Press Ctrl+Space again - verify popup reappears

  **Expected behavior:**
  - Popup is borderless, always on top
  - Search results show: filename, path, size, modified date
  - Keyboard navigation is smooth
  - No lag when typing (debounced search)
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. `cargo build --bin ffi-search` succeeds
2. Binary runs and shows popup on Ctrl+Space
3. Search queries return results from service
4. Keyboard navigation (Up/Down/Enter/Esc) works
5. File actions work (open, reveal, copy)
6. UI is responsive (<50ms search latency with debounce)
</verification>

<success_criteria>
- SRUI-01: Global hotkey opens popup instantly
- SRUI-02: Search-as-you-type with <50ms results
- SRUI-03: Keyboard navigation (Up/Down/Enter/Esc)
- SRUI-04: System theme following (dark/light mode)
- DISP-01: Filename prominent in results
- DISP-02: Full path shown
- DISP-03: Size in human-readable format
- DISP-04: Modified date shown
- ACTN-01: Enter opens file
- ACTN-02: Ctrl+Shift+E reveals in Explorer
- ACTN-03: Ctrl+Shift+C copies path
</success_criteria>

<output>
After completion, create `.planning/phases/03-search-experience/03-02-SUMMARY.md`
</output>
